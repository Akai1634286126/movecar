from flask import Flask, render_template_string
import qrcode
import webbrowser
import threading
import time
import socket

# åˆå§‹åŒ–Flaskåº”ç”¨
app = Flask(__name__)

# è‡ªåŠ¨è·å–æœ¬åœ°å±€åŸŸç½‘IPï¼ˆæ— éœ€æ‰‹åŠ¨æŸ¥è¯¢ï¼ŒPyCharmä¸­ç›´æ¥ç”Ÿæ•ˆï¼‰
def get_local_ip():
    s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    try:
        s.connect(('8.8.8.8', 80))
        ip = s.getsockname()[0]
    finally:
        s.close()
    return ip

# è‡ªå®šä¹‰é…ç½®ï¼ˆåªéœ€æ”¹display_textï¼‰
CONFIG = {
    "display_text": "PyCharmä¸“å±äºŒç»´ç æ–‡æœ¬å±•ç¤º\næ”¯æŒå¤šè¡Œæ–‡æœ¬\nå¯è‡ªç”±ä¿®æ”¹å†…å®¹ï½",
    "local_ip": get_local_ip(),  # è‡ªåŠ¨è·å–IPï¼Œæ— éœ€æ‰‹åŠ¨æ”¹
    "port": 5000
}

# å“åº”å¼UIæ¨¡æ¿ï¼ˆé€‚é…å¾®ä¿¡ï¼‰
HTML_TEMPLATE = """
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡æœ¬å±•ç¤º</title>
    <style>
        body { margin: 20px; padding: 0; font-family: "å¾®è½¯é›…é»‘", sans-serif; background: #f5f5f5; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .text-content { line-height: 1.8; font-size: 18px; color: #333; white-space: pre-line; }
    </style>
</head>
<body>
    <div class="container">
        <div class="text-content">{{ text }}</div>
    </div>
</body>
</html>
"""

@app.route('/')
def show_text():
    return render_template_string(HTML_TEMPLATE, text=CONFIG["display_text"])

def generate_qrcode():
    url = f"http://{CONFIG['local_ip']}:{CONFIG['port']}"
    qr = qrcode.QRCode(
        version=1,
        error_correction=qrcode.constants.ERROR_CORRECT_L,
        box_size=10,
        border=4,
    )
    qr.add_data(url)
    qr.make(fit=True)
    img = qr.make_image(fill_color="black", back_color="white")
    img.save("text_display_qrcode.png")
    print(f"âœ… äºŒç»´ç å·²ä¿å­˜åˆ°é¡¹ç›®æ ¹ç›®å½•ï¼štext_display_qrcode.png")
    print(f"ğŸŒ æœåŠ¡åœ°å€ï¼š{url}")
    print(f"ğŸ“± å¾®ä¿¡æ‰«æäºŒç»´ç å³å¯æŸ¥çœ‹ï¼ˆæ‰‹æœºå’Œç”µè„‘è¿åŒä¸€WiFiï¼‰")

def run_server():
    app.run(host=CONFIG["local_ip"], port=CONFIG["port"], debug=False, use_reloader=False)

if __name__ == "__main__":
    print(f"ğŸ” è‡ªåŠ¨è·å–æœ¬åœ°IPï¼š{CONFIG['local_ip']}")
    generate_qrcode()
    
    # å¯åŠ¨åå°æœåŠ¡
    server_thread = threading.Thread(target=run_server)
    server_thread.daemon = True
    server_thread.start()
    print(f"ğŸš€ FlaskæœåŠ¡å·²å¯åŠ¨")
    
    # è‡ªåŠ¨æ‰“å¼€äºŒç»´ç ï¼ˆPyCharmä¸­ç›´æ¥é¢„è§ˆï¼‰
    time.sleep(1)
    webbrowser.open("text_display_qrcode.png")
    
    input("â¹ï¸  æŒ‰Enteré”®åœæ­¢æœåŠ¡...\n")
